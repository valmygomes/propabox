<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Download API Media as ZIP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
</head>
<body>
<script>
    async function fetchAndZip() {
        const code = new URLSearchParams(window.location.search).get('code');
        if (!code) {
            alert('API code is missing from the URL');
            return;
        }

        const apiUrl = `https://feeds.behold.so/${code}`;
        const zip = new JSZip();
        const folder = zip.folder('instabox');

        try {
            const response = await fetch(apiUrl);
            const mediaList = await response.json();

            // Sort mediaList by timestamp in descending order
            mediaList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            let counter = 1;
            for (const media of mediaList) {
                const mediaUrl = media.mediaUrl;
                const response = await fetch(mediaUrl);
                const blob = await response.blob();
                // Extracting the filename and extension from the media URL
                const extension = mediaUrl.split('?')[0].split('.').pop(); // Extracting extension directly
                const filename = `${code}_${String(counter++).padStart(3, '0')}.${extension}`; // Including API code and padding number
                folder.file(filename, blob);
            }

            const zipBlob = await zip.generateAsync({type: 'blob'});
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(zipBlob);
            link.download = `${code}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error('Error fetching or zipping the files:', error);
        }
    }

    window.addEventListener('load', fetchAndZip);
</script>
</body>
</html>
