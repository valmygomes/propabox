<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Download Instagram Media as ZIP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
</head>
<body>
<script>
    async function fetchAndZip() {
        // Parâmetros obtidos da URL
        const hashtags = new URLSearchParams(window.location.search).get('hashtags');
        const resultsLimit = new URLSearchParams(window.location.search).get('resultsLimit');
        const apiToken = new URLSearchParams(window.location.search).get('apiToken');

        if (!hashtags || !resultsLimit || !apiToken) {
            alert('Missing required parameters in the URL');
            return;
        }

        const apiUrl = `https://insta.ndoohr.com/index.php?hashtags=${encodeURIComponent(hashtags)}&resultsLimit=${encodeURIComponent(resultsLimit)}&apiToken=${encodeURIComponent(apiToken)}`;
        const zip = new JSZip();
        const folder = zip.folder('instabox');

        try {
            const response = await fetch(apiUrl);
            const mediaList = await response.json();

            // Sort mediaList by timestamp in descending order (assumindo que sua API retorna um campo 'timestamp')
            mediaList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            let counter = 1;
            for (const media of mediaList) {
                // Aqui, você precisa ajustar dependendo de como sua API retorna a URL da mídia
                const mediaUrl = media.url; // Ajuste baseado na estrutura de dados que sua API retorna
                const response = await fetch(mediaUrl);
                const blob = await response.blob();
                // Você pode querer ajustar a forma de nomear os arquivos aqui
                const extension = mediaUrl.split('?')[0].split('.').pop();
                const filename = `media_${String(counter++).padStart(3, '0')}.${extension}`;
                folder.file(filename, blob);
            }

            const zipBlob = await zip.generateAsync({type: 'blob'});
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(zipBlob);
            link.download = 'instabox.zip'; // Nome do arquivo ZIP pode ser ajustado conforme necessário
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

        } catch (error) {
            console.error('Error fetching or zipping the files:', error);
        }
    }

    window.addEventListener('load', fetchAndZip);
</script>
</body>
</html>
