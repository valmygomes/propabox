<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Download Instagram Media as ZIP</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
</head>
<body>
<script>
    async function fetchAndZip() {
        const hashtags = new URLSearchParams(window.location.search).get('hashtags');
        const resultsLimit = new URLSearchParams(window.location.search).get('resultsLimit');
        const apiToken = new URLSearchParams(window.location.search).get('apiToken');

        if (!hashtags || !resultsLimit || !apiToken) {
            alert('Missing required parameters in the URL');
            return;
        }

        const apiUrl = `https://insta.ndoohr.com/index.php?hashtags=${encodeURIComponent(hashtags)}&resultsLimit=${encodeURIComponent(resultsLimit)}&apiToken=${encodeURIComponent(apiToken)}`;
        const zip = new JSZip();
        const folder = zip.folder('instabox');

        try {
            const response = await fetch(apiUrl);
            const mediaList = await response.json();

            let counter = 1;
            for (const media of mediaList) {
                // Usando displayUrl para obter a imagem
                const imageUrl = media.displayUrl;
                try {
                    const imageResponse = await fetch(imageUrl);
                    const blob = await imageResponse.blob();
                    if (blob.size > 0) {
                        const extension = imageUrl.split('?')[0].split('.').pop();
                        const filename = `media_${String(counter++).padStart(3, '0')}.${extension}`;
                        folder.file(filename, blob);
                    } else {
                        console.error('Failed to download image:', imageUrl);
                    }
                } catch (imageError) {
                    console.error('Error downloading image:', imageUrl, imageError);
                }
            }

            const zipBlob = await zip.generateAsync({type: 'blob'});
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(zipBlob);
            link.download = 'instabox.zip';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (error) {
            console.error('Error fetching or zipping the files:', error);
        }
    }

    window.addEventListener('load', fetchAndZip);
</script>
</body>
</html>
